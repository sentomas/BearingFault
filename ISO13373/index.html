<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 13773 Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-gray-800">Machine Bearing Analyzer</h1>
            <p class="text-gray-600">Envelope Analysis & Fault Detection</p>
        </nav>
    </header>

    <main class="container mx-auto p-6">
        <div id="analysis-panel" class="space-y-6">
            <form id="analysis-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">1. Machine Config</h3>
                    <div>
                        <label for="rpm" class="block text-sm font-medium text-gray-600">Speed (RPM)</label>
                        <input type="number" id="rpm" value="1780" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">2. Geometry</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="n_b" class="block text-sm font-medium text-gray-600">Balls (N_b)</label>
                            <input type="number" id="n_b" value="9" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="d_b" class="block text-sm font-medium text-gray-600">Ball Dia (mm)</label>
                            <input type="number" id="d_b" value="12.0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="d_p" class="block text-sm font-medium text-gray-600">Pitch (mm)</label>
                            <input type="number" id="d_p" value="75.0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="beta" class="block text-sm font-medium text-gray-600">Angle (Â°)</label>
                            <input type="number" id="beta" value="15.0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">3. Upload CSV</h3>
                    <div>
                        <label for="file" class="block text-sm font-medium text-gray-600">File (.csv)</label>
                        <input type="file" id="file" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <div class="pt-4 space-y-4">
                        <label class="block text-sm font-medium text-gray-600">Column Names</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="time_col" value="Time" class="block w-full rounded-md border-gray-300 shadow-sm text-sm">
                            <input type="text" id="signal_col" value="Amplitude" class="block w-full rounded-md border-gray-300 shadow-sm text-sm">
                        </div>
                    </div>
                </div>

                <div class="md:col-span-3">
                    <button type="submit" class="w-full flex justify-center py-3 px-6 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700">
                        Run Full Analysis
                    </button>
                </div>
            </form>
            
            <!-- Results Container -->
            <div id="results-container" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200" style="display: none;">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-3">Analysis Results</h3>
                
                <div class="mb-8 mt-4">
                     <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2">1. Time Waveform (Downsampled View)</h4>
                     <div id="plot-time" class="w-full h-[250px] border border-gray-100 rounded"></div>
                </div>

                <div class="mb-8">
                    <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2">2. Envelope Spectrum</h4>
                    <div id="plot-spectrum" class="w-full h-[500px] border border-gray-100 rounded"></div>
                </div>

                <!-- Info Cards -->
                <div class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
                    <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                        <div class="text-xs font-medium text-gray-500">Shaft (1X)</div>
                        <div id="res-f_r" class="text-lg font-bold text-blue-700">- Hz</div>
                    </div>
                    <div class="bg-red-50 p-3 rounded-md border border-red-100">
                        <div class="text-xs font-medium text-gray-500">Outer (BPFO)</div>
                        <div id="res-bpfo" class="text-lg font-bold text-red-700">- Hz</div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-md border border-orange-100">
                        <div class="text-xs font-medium text-gray-500">Inner (BPFI)</div>
                        <div id="res-bpfi" class="text-lg font-bold text-orange-700">- Hz</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-md border border-purple-100">
                        <div class="text-xs font-medium text-gray-500">Ball Spin (BSF)</div>
                        <div id="res-bsf" class="text-lg font-bold text-purple-700">- Hz</div>
                    </div>
                    <div class="bg-teal-50 p-3 rounded-md border border-teal-100">
                        <div class="text-xs font-medium text-gray-500">Cage (FTF)</div>
                        <div id="res-ftf" class="text-lg font-bold text-teal-700">- Hz</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
                        <div class="text-xs font-medium text-gray-500">Sampling Freq</div>
                        <div id="res-fs" class="text-lg font-bold text-gray-700">- Hz</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message/Loading Overlay -->
        <div id="message-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
            <div classs="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
                <div id="message-loading" class="space-y-4">
                    <!-- SVG Spinner -->
                    <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class"opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-lg font-medium text-white">Processing... Please wait.</p>
                </div>
                <div id="message-error" class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center" style="display: none;">
                    <h3 class="text-xl font-bold text-red-600 mb-4">Error</h3>
                    <p id="error-text" class="text-sm text-gray-600 text-left"></p>
                    <button onclick="document.getElementById('message-overlay').style.display='none'" class="mt-6 w-full py-2 px-4 bg-red-600 text-white rounded">Close</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- IMPORTANT ---
        // This MUST point to your running API (either local or deployed)
        const API_BASE_URL = 'http://localhost:8000'; // For local testing
        //const API_BASE_URL = 'https://github.com/sentomas/BearingFault'; // This is WRONG, see comment below
        
        // --- NOTE ---
        // 'https://github.com/sentomas/BearingFault' is NOT a running API server.
        // It is a code repository. You must run your 'api.jl' or 'main.py'
        // on a server (like Render.com or locally) and put THAT URL here.
        // For local testing, use 'http://localhost:8000' and run 'julia api.jl'

        const analysisForm = document.getElementById('analysis-form');
        const resultsContainer = document.getElementById('results-container');
        const messageOverlay = document.getElementById('message-overlay');
        const messageLoading = document.getElementById('message-loading');
        const messageError = document.getElementById('message-error');
        const errorText = document.getElementById('error-text');

        function getFormData() {
            return {
                rpm: document.getElementById('rpm').value,
                n_b: document.getElementById('n_b').value,
                d_b: document.getElementById('d_b').value,
                d_p: document.getElementById('d_p').value,
                beta: document.getElementById('beta').value
            };
        }

        analysisForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            resultsContainer.style.display = 'none';
            const fileInput = document.getElementById('file');
            if (fileInput.files.length === 0) { 
                alert('Please select a CSV file'); 
                return; 
            }

            const formData = new FormData();
            const params = getFormData();
            Object.keys(params).forEach(key => formData.append(key, params[key]));
            formData.append('file', fileInput.files[0]);
            formData.append('time_col', document.getElementById('time_col').value);
            formData.append('signal_col', document.getElementById('signal_col').value);

            messageOverlay.style.display = 'flex';
            messageLoading.style.display = 'block';
            messageError.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/analyze/upload`, { method: 'POST', body: formData });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Server Error');
                
                messageOverlay.style.display = 'none';
                displayResults(data);
            } catch (err) {
                messageLoading.style.display = 'none';
                messageError.style.display = 'block';
                errorText.textContent = err.message + "\n\n(Is your API server running at " + API_BASE_URL + "?)";
            }
        });

        function displayResults(data) {
            resultsContainer.style.display = 'block';
            const spectrum = data.envelope_spectrum;
            const freqs = data.fault_frequencies;
            const wave = data.time_waveform;

            // Update Cards
            document.getElementById('res-f_r').textContent = `${freqs.f_r.toFixed(2)} Hz`;
            document.getElementById('res-bpfo').textContent = `${freqs.bpfo.toFixed(2)} Hz`;
            document.getElementById('res-bpfi').textContent = `${freqs.bpfi.toFixed(2)} Hz`;
            document.getElementById('res-bsf').textContent = `${freqs.bsf.toFixed(2)} Hz`;
            document.getElementById('res-ftf').textContent = `${freqs.ftf.toFixed(2)} Hz`;
            document.getElementById('res-fs').textContent = `${data.metadata.sampling_frequency_hz.toFixed(0)} Hz`;

            // 1. Time Plot
            Plotly.newPlot('plot-time', [{
                x: wave.t, y: wave.signal, type: 'scatter', mode: 'lines', line: { color: '#3b82f6', width: 1 }
            }], {
                margin: { t: 10, b: 30, l: 40, r: 10 },
                xaxis: { title: 'Time (s)' }, yaxis: { title: 'Amp' }
            }, {responsive: true});

            // 2. Spectrum Plot
            // --- UPDATED PLOT LAYOUT ---
            Plotly.newPlot('plot-spectrum', [{
                x: spectrum.frequencies, y: spectrum.magnitudes, type: 'scatter', mode: 'lines', line: { color: '#1f2937' }
            }], {
                xaxis: { title: 'Frequency (Hz)', range: [0, freqs.bpfi * 1.5] }, // Zoom to 1.5x BPFI
                yaxis: { title: 'Magnitude' },
                shapes: [
                    // Shaft (1X) - Blue
                    { type: 'line', x0: freqs.f_r, x1: freqs.f_r, y0: 0, y1: 1, yref: 'paper', line: { color: 'blue', dash: 'dashdot', width: 1 } },
                    // BPFO - Red
                    { type: 'line', x0: freqs.bpfo, x1: freqs.bpfo, y0: 0, y1: 1, yref: 'paper', line: { color: 'red', dash: 'dash', width: 2 } },
                    // BPFI - Orange
                    { type: 'line', x0: freqs.bpfi, x1: freqs.bpfi, y0: 0, y1: 1, yref: 'paper', line: { color: 'orange', dash: 'dash', width: 2 } },
                    // BSF - Purple
                    { type: 'line', x0: freqs.bsf, x1: freqs.bsf, y0: 0, y1: 1, yref: 'paper', line: { color: 'purple', dash: 'dot', width: 1.5 } },
                    // FTF - Teal
                    { type: 'line', x0: freqs.ftf, x1: freqs.ftf, y0: 0, y1: 1, yref: 'paper', line: { color: 'teal', dash: 'dot', width: 1 } }
                ],
                annotations: [
                    { x: freqs.f_r, y: 1.0, yref: 'paper', text: '1X', showarrow: false, yanchor: 'top', font: {color: 'blue'} },
                    { x: freqs.bpfo, y: 1.0, yref: 'paper', text: 'BPFO', showarrow: false, yanchor: 'top', font: {color: 'red'} },
                    { x: freqs.bpfi, y: 0.95, yref: 'paper', text: 'BPFI', showarrow: false, yanchor: 'top', font: {color: 'orange'} },
                    { x: freqs.bsf, y: 0.90, yref: 'paper', text: 'BSF', showarrow: false, yanchor: 'top', font: {color: 'purple'} },
                    { x: freqs.ftf, y: 0.85, yref: 'paper', text: 'FTF', showarrow: false, yanchor: 'top', font: {color: 'teal'} }
                ]
            }, {responsive: true});
        }
    </script>
</body>
</html>